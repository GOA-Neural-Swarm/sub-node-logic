name: Cluster Sub-node Sync

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4

      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install All Neural Dependencies
        run: |
          npm init -y
          npm install @octokit/rest firebase-admin axios @supabase/supabase-js pg
          echo "‚úÖ Trinity Modules Installed."

      # üî± ·Äñ·Ä≠·ÄØ·ÄÑ·Ä∫·Äî·Ä¨·Äô·Ää·Ä∫·ÄÄ·Ä≠·ÄØ ·Ä°·Äú·Ä≠·ÄØ·Ä°·Äú·Äª·Ä±·Ä¨·ÄÄ·Ä∫ ·Äõ·Äæ·Ä¨·Äñ·ÄΩ·Ä±·Äï·Äº·ÄÆ·Ä∏ Run ·Äô·Ää·Ä∑·Ä∫ ·Ä°·Äï·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏
      - name: Execute Swarm Logic
        run: |
          if [ -f "delta_sync.js" ]; then
            node delta_sync.js
          elif [ -f "cluster_sync.js" ]; then
            node cluster_sync.js
          else
            echo "‚ùå ERROR: Neither delta_sync.js nor cluster_sync.js found!"
            ls -R
            exit 1
          fi
        env:
          NEON_KEY: ${{ secrets.NEON_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          FIREBASE_KEY: ${{ secrets.FIREBASE_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
